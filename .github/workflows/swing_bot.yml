name: Swing Bot (Production)

on:
  schedule:
    # Schedule (Mon-Fri)
    # 09:10 IST (Pre-Market) -> 03:40 UTC
    - cron: '40 3 * * 1-5'
    # 09:30 IST (Open/Trade) -> 04:00 UTC
    - cron: '0 4 * * 1-5'
    # 11:30 IST (Trade)      -> 06:00 UTC
    - cron: '0 6 * * 1-5'
    # 13:00 IST (Trade)      -> 07:30 UTC
    - cron: '30 7 * * 1-5'
    # 15:10 IST (Trade)      -> 09:40 UTC
    - cron: '40 9 * * 1-5'
    # 16:30 IST (Post-Market)-> 11:00 UTC
    - cron: '0 11 * * 1-5'
    
  workflow_dispatch:

jobs:
  swing-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        
    - name: Run Bot (One-Shot Cloud Mode)
      env:
        GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        DISCORD_WEBHOOKS: ${{ secrets.DISCORD_WEBHOOKS }}
        DISCORD_WEBHOOK_BOT: ${{ secrets.DISCORD_WEBHOOK_BOT }}
        DISCORD_WEBHOOK_STOCKS: ${{ secrets.DISCORD_WEBHOOK_STOCKS }}
        ANGEL_ONE_CREDENTIALS: ${{ secrets.ANGEL_ONE_CREDENTIALS }}
      run: |

        mkdir -p .streamlit
        pip install toml

        # Generate Secrets Script
        cat <<EOF > generate_secrets.py
        import os
        import toml

        # 1. Passwords
        secrets = {'passwords': {'admin': 'swing123'}}

        # 2. Discord
        generic = os.getenv('DISCORD_WEBHOOKS')
        if generic:
            secrets['discord_webhook_bot'] = generic
            secrets['discord_webhook_stocks'] = generic
        else:
            bot = os.getenv('DISCORD_WEBHOOK_BOT')
            stocks = os.getenv('DISCORD_WEBHOOK_STOCKS')
            if bot: secrets['discord_webhook_bot'] = bot
            if stock_token: secrets['discord_webhook_stocks'] = stock_token

        # 3. Validation & Merge Angel Credentials
        angel_raw = os.getenv('ANGEL_ONE_CREDENTIALS')
        if angel_raw:
            try:
                # Try to parse the user's TOML block
                angel_dict = toml.loads(angel_raw)
                # Merge into main secrets
                secrets.update(angel_dict)
                print("✅ ANGEL_ONE_CREDENTIALS parsed and merged.")
            except Exception as e:
                print(f"⚠️ WARNING: Could not parse ANGEL_ONE_CREDENTIALS as TOML: {e}")
                print("Falling back to raw append (Risk of syntax errors).")
                # We can't merge, so we must append later or fail? 
                # Let's try to append raw as a fallback, but likely it will fail again.
                # BETTER: Fail the build so user knows.
                # But let's append for now to be safe with partial data?
                # No, mixed append is messy. Let's just append raw if parse fails.

        # Write TOML (Safe Dump)
        with open('.streamlit/secrets.toml', 'w') as f:
            toml.dump(secrets, f)
            
        if angel_raw and 'angel' not in secrets and 'ANGEL_API_KEY' not in secrets:
             # If we failed to parse/merge, append raw (Fallback)
             print("⚠️ Appending Raw Angel Credentials (Fallback)")
             with open('.streamlit/secrets.toml', 'a') as f:
                f.write('\n' + angel_raw + '\n')
        EOF

        # Run Generator
        python generate_secrets.py
        
        # DEBUG: Show File Content (Secrets will be masked by GitHub automatically)
        echo "--- DEBUG: SECRETS.TOML CONTENT ---"
        cat .streamlit/secrets.toml
        echo "-----------------------------------"
        
        # Run Bot
        python swing_bot.py
