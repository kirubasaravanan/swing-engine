name: Swing Bot (Production)

on:
  schedule:
    # Schedule (Mon-Fri)
    # 09:10 IST (Pre-Market) -> 03:40 UTC
    - cron: '40 3 * * 1-5'
    # 09:30 IST (Open/Trade) -> 04:00 UTC
    - cron: '0 4 * * 1-5'
    # 11:30 IST (Trade)      -> 06:00 UTC
    - cron: '0 6 * * 1-5'
    # 13:00 IST (Trade)      -> 07:30 UTC
    - cron: '30 7 * * 1-5'
    # 15:10 IST (Trade)      -> 09:40 UTC
    - cron: '40 9 * * 1-5'
    # 16:30 IST (Post-Market)-> 11:00 UTC
    - cron: '0 11 * * 1-5'
    
  workflow_dispatch:

jobs:
  swing-bot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        pip install -r requirements.txt
        
    - name: Run Bot (One-Shot Cloud Mode)
      env:
        GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        DISCORD_WEBHOOKS: ${{ secrets.DISCORD_WEBHOOKS }}
        DISCORD_WEBHOOK_BOT: ${{ secrets.DISCORD_WEBHOOK_BOT }}
        DISCORD_WEBHOOK_STOCKS: ${{ secrets.DISCORD_WEBHOOK_STOCKS }}
        ANGEL_ONE_CREDENTIALS: ${{ secrets.ANGEL_ONE_CREDENTIALS }}
      run: |

        mkdir -p .streamlit
        pip install toml

        # Generate Secrets Script
        cat <<EOF > generate_secrets.py
        import os
        import toml

        # 1. Passwords
        secrets = {'passwords': {'admin': 'swing123'}}

        # 2. Discord
        generic = os.getenv('DISCORD_WEBHOOKS')
        if generic:
            secrets['discord_webhook_bot'] = generic
            secrets['discord_webhook_stocks'] = generic
        else:
            bot = os.getenv('DISCORD_WEBHOOK_BOT')
            stocks = os.getenv('DISCORD_WEBHOOK_STOCKS')
            if bot: secrets['discord_webhook_bot'] = bot
            if stocks: secrets['discord_webhook_stocks'] = stocks

        # Write TOML
        with open('.streamlit/secrets.toml', 'w') as f:
            toml.dump(secrets, f)

        # 3. Append Angel (Raw)
        angel_raw = os.getenv('ANGEL_ONE_CREDENTIALS')
        if angel_raw:
            with open('.streamlit/secrets.toml', 'a') as f:
                f.write('\n' + angel_raw + '\n')
        EOF

        # Run Generator
        python generate_secrets.py
        
        # Run Bot
        python swing_bot.py
